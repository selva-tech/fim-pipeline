configuration:
  dependencies:
  - "mvn://com.walmartlabs.concord.plugins:jira-task:1.39.0"
  - mvn://com.squareup.okio:okio:1.13.0
  - mvn://com.squareup.okhttp3:okhttp:3.9.1
  - mvn://org.codehaus.groovy:groovy-all:pom:2.5.2
  
flows:
  default:
    - log: "Hello, ${fimName} - ${fimLines} - ${fimHost}"
    - script: groovy
      body: |
        import groovy.json.JsonSlurper 
        def jsonSlurper = new JsonSlurper()
        def object = jsonSlurper.parseText(fimLines) 
        println ( "Line object " + object)
        println ( "-----------------------")
        println ( "Line _line " + object._line)
        println ( "-----------------------")
        def object_lines = jsonSlurper.parseText(object._line) 
        println ( "Line calendarTime " + object_lines.calendarTime)
        println ( "-----------------------")
        println ( "Line columns " + object_lines.columns) 
        println ( "-----------------------")
        def object_lines_column = jsonSlurper.parseText(object_lines.columns) 
        println ( "Line object_lines.columns " + object_lines_column.target_path) 
        
        execution.setVariable("target_path", object_lines_column.target_path)
        
    - log: "Hello, ${target_path}"
    - task: http
      in:
        auth:
          basic:
            username: mselvarajumca@gmail.com
            password: "${crypto.exportAsString('Default', 'jira-apikey',null)}"
        request: json
        method: POST
        url: "https://macefimeteam.atlassian.net/rest/api/2/issue"
        body: |
          {
           "fields": {
             "project":
               {
                  "key": "WEB"
               },
               "summary": "FIM A file has been changed - ${fimName} -  ${fimHost}",
               "description": "FIM A file has been changed - ${fimName} -  ${fimHost} - \n  ${target_path} ",
               "issuetype": {
                  "name": "Bug"
               }
            }
          }
        response: json
        out: jsonResponse
    - if: ${jsonResponse.success}
      then:
       - log: "Response received: ${jsonResponse.content}"

    - log: "Done!"

